name: Build Dev-Base Images

on:
  push:
    branches: ['**']
    paths:
      # Backend dependency triggers
      - 'backend/api-gateway/*.csproj'
      - 'backend/user-service/*.csproj'
      - 'backend/social-service/*.csproj'
      - 'container/dockerfiles/dev/*.dev-base.Dockerfile'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      gateway: ${{ steps.filter.outputs.gateway }}
      user: ${{ steps.filter.outputs.user }}
      social: ${{ steps.filter.outputs.social }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gateway:
              - 'backend/api-gateway/*.csproj'
              - 'container/dockerfiles/dev/gateway.dev-base.Dockerfile'
            user:
              - 'backend/user-service/*.csproj'
              - 'container/dockerfiles/dev/user.dev-base.Dockerfile'
            social:
              - 'backend/social-service/*.csproj'
              - 'container/dockerfiles/dev/social.dev-base.Dockerfile'
  
  build-gateway-dev:
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and push gateway dev-base
        uses: docker/build-push-action@v5
        with:
          context: ./backend/api-gateway
          file: ./container/dockerfiles/dev/gateway.dev-base.Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/snms-api-gateway:dev-${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/snms-api-gateway:dev-latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/snms-api-gateway:dev-latest
          cache-to: type=inline

  build-user-dev:
    needs: detect-changes
    if: needs.detect-changes.outputs.user == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and push user-service dev-base
        uses: docker/build-push-action@v5
        with:
          context: ./backend/user-service
          file: ./container/dockerfiles/dev/user.dev-base.Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/snms-user-service:dev-${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/snms-user-service:dev-latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/snms-user-service:dev-latest
          cache-to: type=inline

  build-social-dev:
    needs: detect-changes
    if: needs.detect-changes.outputs.social == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and push social-service dev-base
        uses: docker/build-push-action@v5
        with:
          context: ./backend/social-service
          file: ./container/dockerfiles/dev/social.dev-base.Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/snms-social-service:dev-${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/snms-social-service:dev-latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/snms-social-service:dev-latest
          cache-to: type=inline

  notify:
    needs: [build-gateway-dev, build-user-dev, build-social-dev]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify team
        run: |
          echo "ðŸŽ‰ Dev-base images updated!"
          echo "Team members: Run 'docker compose pull && docker compose up -d'"
