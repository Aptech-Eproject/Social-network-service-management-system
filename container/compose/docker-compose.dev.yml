services:
  # API GATEWAY - Public
  api-gateway:
    image: minhtri269/snms-api-gateway:dev-latest
    container_name: snms-gateway-dev
    ports:
      - "8000:8000"
    volumes:
      - ../../backend/api-gateway:/app
      - gateway_bin:/app/bin
      - gateway_obj:/app/obj
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8000
      DOTNET_USE_POLLING_FILE_WATCHER: "true"
      DOTNET_WATCH_RESTART_ON_RUDE_EDIT: "true"
    command: dotnet watch --project api-gateway.csproj run --no-launch-profile
    depends_on:
      - user-service
      - social-service
      - redis
    deploy:
      resources:
        limits:
          cpus: 1
          memory: 512MB
        reservations:
          cpus: 0.5
          memory: 256MB
    networks:
      - snms-network
    restart: unless-stopped

  #  USER SERVICE - Internal
  user-service:
    image: minhtri269/snms-user-service:dev-latest
    container_name: snms-user-dev
    expose:
      - "8081"
    volumes:
      - ../../backend/user-service:/app
      - user_bin:/app/bin
      - user_obj:/app/obj
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8081
      DOTNET_USE_POLLING_FILE_WATCHER: "true"
      DOTNET_WATCH_RESTART_ON_RUDE_EDIT: "true"
    command: dotnet watch --project user-service.csproj run --no-launch-profile
    depends_on:
      mysql-db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - snms-network
    deploy:
      resources:
        limits:
          cpus: 0.5
          memory: 512MB
        reservations:
          cpus: 0.25
          memory: 256MB
    restart: unless-stopped

  # SOCIAL SERVICE - Internal
  social-service:
    image: minhtri269/snms-social-service:dev-latest
    container_name: snms-social-dev
    expose:
      - "8082"
    volumes:
      - ../../backend/social-service:/app
      - social_bin:/app/bin
      - social_obj:/app/obj
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8082
      DOTNET_USE_POLLING_FILE_WATCHER: "true"
      DOTNET_WATCH_RESTART_ON_RUDE_EDIT: "true"
    command: dotnet watch --project social-service.csproj run --no-launch-profile
    depends_on:
      mysql-db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - snms-network
    deploy:
      resources:
        limits:
          cpus: 0.5
          memory: 512MB
        reservations:
          cpus: 0.25
          memory: 256MB
    restart: unless-stopped

  # REDIS - Cache 
  redis:
    image: redis:7-alpine
    container_name: snms-redis-dev
    ports:
      - "6379:6379"          
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - snms-network
    deploy:
      resources:
        limits:
          cpus: 0.25
          memory: 512MB
        reservations:
          cpus: 0.25
          memory: 256MB
    restart: unless-stopped

  # Database: SQL Server
  mysql-db:
    image: mysql:8.0
    container_name: mysql_dev
    environment:
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3306:3306"          
    volumes:
      - mysql_data_dev:/var/lib/mysql
      - ../script/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    command:
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: 0.5
          memory: 1GB
        reservations:
          cpus: 0.5
          memory: 512MB
    networks:
      - snms-network

  #  phpMyAdmin â€” optional dev tool
  phpmyadmin:
    image: phpmyadmin:5
    container_name: phpmyadmin_dev
    ports:
      - "8070:80"
    environment:
      PMA_HOST: mysql-db
      PMA_USER: root
      PMA_PASSWORD: root
    deploy:
      resources:
        limits:
          cpus: 0.25
          memory: 64M
        reservations:
          cpus: 0.25
          memory: 32M
    networks:
      - snms-network
#=============================================================
networks:
  snms-network:
    driver: bridge
    name: snms-dev-network

volumes:
  gateway_bin:
    name: gateway_bin
  gateway_obj:
    name: gateway_obj
  user_bin:
    name: user_bin
  user_obj:
    name: user_obj
  social_bin:
    name: cocial_bin
  social_obj:
    name: socaial_obj
  mysql_data_dev:
    name: mysql_data_dev
  redis_data:
    name: redis_data